# ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆé–‹ç™ºã‚¬ã‚¤ãƒ‰ (v2.1)
## GameCenter ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ é€£æºä»•æ§˜æ›¸

> **ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:**
> - **æœ¬æ›¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** v2.1 (2025-09-07)
> - **å¯¾å¿œã™ã‚‹ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** v0.1.0

---

## ğŸ“‹ ã“ã®ã‚¬ã‚¤ãƒ‰ã«ã¤ã„ã¦

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ **GameCenter ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“** ç”¨ã®ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®ä»•æ§˜æ›¸ã§ã™ã€‚

---

## ğŸ¯ å¿…é ˆå®Ÿè£…é …ç›®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆã¨ã—ã¦ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã«èªè­˜ãƒ»é€£æºã•ã‚Œã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®APIã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

- `POST /game/init`: ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
- `POST /game/event`: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç™ºç”Ÿæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
- `POST /game/timer_expired`: (å°†æ¥å®Ÿè£…äºˆå®š) ã‚¿ã‚¤ãƒãƒ¼æº€äº†æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
- `GET /game/info`: (å°†æ¥å®Ÿè£…äºˆå®š) ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ãŒã‚²ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

---

## ğŸ”§ APIå®Ÿè£…ä»•æ§˜ (ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆå´)

ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆãŒå®Ÿè£…ã™ã¹ãHTTP APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä»•æ§˜ã§ã™ã€‚

### 1. ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã¨ã®é€šä¿¡è¨­å®š
- **URL**: ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã®URLã¯ã€ç’°å¢ƒå¤‰æ•° `GAME_ENGINE_API_BASE` ã§æ¸¡ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ `http://localhost:3000` ã§ã™ã€‚
- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: HTTP/JSON
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 500msä»¥ä¸‹ã®å¿œç­”ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

### 2. å¿…é ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### POST /game/init
ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

```json
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ â†’ ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆï¼‰
{
  "room_id": "12345",
  "players": [
    {"id": "player1_uuid", "display_name": "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1"},
    {"id": "player2_uuid", "display_name": "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2"}
  ],
  "settings": {}
}

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ â†’ ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ï¼‰
// ç¾åœ¨ã®å®Ÿè£…ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“ãŒã€å°†æ¥çš„ã«UIã®åˆæœŸåŒ–ãªã©ã«åˆ©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
{
  "status": "success"
}
```

#### POST /game/event
ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ—©æŠ¼ã—ãªã©ï¼‰ãŒç™ºç”Ÿã—ãŸéš›ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

```json
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ â†’ ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆï¼‰
{
  "room_id": "12345",
  "data": {
    "action": "first_press",
    "winner": "player1_uuid"
  }
}

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆ â†’ ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ï¼‰
{
  "status": "event_handled"
}
```

#### POST /game/timer_expired (å°†æ¥å®Ÿè£…äºˆå®š)
ã‚¿ã‚¤ãƒãƒ¼ãŒæº€äº†ã—ãŸéš›ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

---

## ğŸš€ ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“APIæ´»ç”¨ (ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆå´ã‹ã‚‰å‘¼ã³å‡ºã™API)

ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆã‹ã‚‰ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ã‚²ãƒ¼ãƒ ã‚’é€²è¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### 1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã®åˆ¶å¾¡

#### åŒæ™‚é…ä¿¡ã§ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åŒæ™‚ã«æƒ…å ±ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆï¼ˆå•é¡Œè¡¨ç¤ºãªã©ï¼‰ã«ä½¿ç”¨ã—ã¾ã™ã€‚
```python
# POST /realtime/broadcast
requests.post(f'{GAME_ENGINE_URL}/realtime/broadcast', 
  json={
    "room_id": "12345",
    "event_type": "question_display",
    "data": {"question": "æ—¥æœ¬ã§ä¸€ç•ªé«˜ã„å±±ã¯ï¼Ÿ"}
  }
)
```

#### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹åŒ–
æ—©æŠ¼ã—ãƒœã‚¿ãƒ³ãªã©ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å—ä»˜ã‚’é–‹å§‹/çµ‚äº†ã—ã¾ã™ã€‚
```python
# POST /realtime/enable_action
requests.post(f'{GAME_ENGINE_URL}/realtime/enable_action', 
  json={
    "room_id": "12345",
    "action_type": "first_press",
    "enabled": True
  }
)
```

#### ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ (å°†æ¥å®Ÿè£…äºˆå®š)
æŒ‡å®šã—ãŸæ™‚é–“ã§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚
```python
# POST /realtime/start_timer
requests.post(f'{GAME_ENGINE_URL}/realtime/start_timer', 
  json={
    "room_id": "12345",
    "timer_id": "answer_time",
    "duration": 30
  }
)
```

### 2. ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®æ›´æ–°

#### ã‚²ãƒ¼ãƒ ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´
ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºï¼‰ã‚’æ›´æ–°ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®UIè¡¨ç¤ºã‚’å¤‰åŒ–ã•ã›ã¾ã™ã€‚
```python
# POST /game/next_phase
requests.post(f'{GAME_ENGINE_URL}/game/next_phase', 
  json={
    "room_id": "12345",
    "phase": "answering",
    "ui_data": {
        "message": "Player1ãŒå›ç­”ä¸­ã§ã™ï¼",
        "winner": "player1_uuid"
    }
  }
)
```

#### UIã®å‹•çš„æ›´æ–° (å°†æ¥å®Ÿè£…äºˆå®š)
ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã«ã€ã‚ˆã‚Šè©³ç´°ãªUIæ›´æ–°ã‚’æŒ‡ç¤ºã™ã‚‹APIã§ã™ã€‚

---

## ğŸ“ å®Ÿè£…ä¾‹ (Python / Flask)

`games/quiz/app.py` ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```python
import os
from flask import Flask, request, jsonify
import requests

app = Flask(__name__)

# ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
GAME_ENGINE_URL = os.environ.get("GAME_ENGINE_API_BASE", "http://localhost:3000")

# ç°¡å˜ãªã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªçŠ¶æ…‹ç®¡ç†
game_state = {}

def send_to_game_engine(endpoint, data):
    """ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°"""
    try:
        url = f"{GAME_ENGINE_URL}{endpoint}"
        print(f"Sending request to {url} with data: {data}")
        response = requests.post(url, json=data)
        response.raise_for_status()
        print(f"Successfully sent request to {endpoint}")
    except requests.exceptions.RequestException as e:
        print(f"Error sending request to {endpoint}: {e}")

@app.route("/game/init", methods=["POST"])
def init_game():
    data = request.json
    room_id = data.get("room_id")
    if not room_id:
        return "room_id is required", 400

    print(f"Initializing game for room {room_id}")
    game_state[room_id] = {"winner": None, "question": "Rustã§æœ€ã‚‚äººæ°—ã®ã‚ã‚‹Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ï¼Ÿ"}

    # 1. å•é¡Œã‚’å…¨å“¡ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    send_to_game_engine("/realtime/broadcast", {
        "room_id": room_id,
        "event_type": "question_display",
        "data": {"question": game_state[room_id]["question"]}
    })

    # 2. æ—©æŠ¼ã—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‚ˆã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    send_to_game_engine("/realtime/enable_action", {
        "room_id": room_id,
        "action_type": "first_press",
        "enabled": True
    })
    
    return jsonify({"status": "initialized"})

@app.route("/game/event", methods=["POST"])
def handle_event():
    data = request.json
    room_id = data.get("room_id")
    event_data = data.get("data", {})
    
    if not room_id:
        return "room_id is required", 400

    print(f"Received event for room {room_id}: {data}")

    if event_data.get("action") == "first_press":
        winner_id = event_data.get("winner")
        if winner_id:
            game_state.setdefault(room_id, {})["winner"] = winner_id
            print(f"Winner in room {room_id} is {winner_id}")

            # å›ç­”ãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œã™ã‚‹ã‚ˆã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            send_to_game_engine("/game/next_phase", {
                "room_id": room_id,
                "phase": "answering",
                "ui_data": {
                    "message": f"Player {winner_id} is answering!",
                    "winner": winner_id
                }
            })

    return jsonify({"status": "event_handled"})

if __name__ == "__main__":
    # ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆã¯5001ç•ªãƒãƒ¼ãƒˆã§èµ·å‹•
    app.run(host="0.0.0.0", port=5001, debug=True)
```
